#!/usr/bin/env node
var debug = require('debug')('cnpm:install')
var dirname = require('path').dirname
var join = require('path').join

var mkdirp = require('../lib/mkdirp')
var getPath = require('../lib/get_path')
var install = require('../lib/install')
var Promise = require('../lib/promise')

const cli = require('meow')([
  'Usage:',
  '  $ cnpm install',
  '  $ cnpm install <name>',
  '',
  'Options:',
  '  -S, --save            save into package.json under dependencies',
  '  -D, --save-dev        save into package.json under devDependencies',
  '  -E, --save-exact      save exact spec',
  '',
  '      --dry-run         simulate',
  '  -g, --global          install globally',
  '',
  '      --production      don\'t install devDependencies'
].join('\n'), {
  boolean: [ 'save-dev', 'save', 'save-exact', 'dry-run', 'global' ],
  alias: {
    D: 'save-dev',
    S: 'save',
    E: 'save-exact',
    g: 'global'
  }
})

/*
 * Install multiple modules
 */

function installMultiple (ctx, pkgs, options) {
  return Promise.all(pkgs.map(function (pkg) {
    return install(ctx, pkg, options)
  }))
}

/*
 * Perform
 */

if (!module.parent) {
  var ctx = {}

  getPath()
    .then(_ => updateContext(_))
    .then(_ => mkdirp(ctx.modules))
    .then(_ => installMultiple(ctx, cli.input, cli.flags))
    .catch(require('../lib/err'))

  function updateContext (root) {
    ctx.root = root
    ctx.modules = join(root, 'node_modules')
  }
}
